from distutils.command.upload import upload
from django import forms
from django.shortcuts import get_object_or_404
from .models import Project, Link, Subdomain, HttpServices

class ProjectName(forms.ModelForm):
    class Meta:
        model = Project
        fields = "__all__"

        def save(self,pk):
            
            # data = self.cleaned_data['subdomains']
            link = Link.objects.filter(id = pk)

            subdomain = Subdomain(link = link, )
            

class Links(forms.Form):
    links = forms.CharField(widget=forms.Textarea)

    # File Upload
    links_file = forms.FileField(required=False)

    def save(self, pk, file_domains):
        data = self.cleaned_data['links']
        whole_link = data.split('\r\n')
        whole_link = set(whole_link)
       
        """
        1 Formdan veriler al
        2 db den verileri al
        3 db de ve formda cakisan verileri teke düsür yeni listeye koy
        4 dosyadan gelen verileri yeni listeyle kıyasla yoksa ekle
        5 her link-domaini db ye kaydet
        """


        proj = Project.objects.get(id = pk)
        links = Link.objects.filter(project = proj)



        link_list = [str(link) for link in links]


        new_linklist = [link for link in whole_link if link not in link_list]
        
        
        if len(file_domains) != 0:

            for domain in file_domains:
                if str(domain) not in new_linklist and str(domain) not in link_list:
                    new_linklist.append(domain)


        for item in new_linklist:
            link = Link(project = proj, link = item)
            link.save()
            #Resullerin fonksiyon burda çalışacak sonucu subdomains save ile kaydedicek



            for item in ['wwww.gmail.com', 'www.fotograflar.com', 'www.meetings.com']:# Link yerine resullerin fonksiyonunun listesi gelicek unique olması laızm
                linkobj = Link.objects.get(id = link.id)
                sub = Subdomain(project = proj , link = linkobj, subdomain = item)
                sub.save()

class SubdomainForm(forms.Form):
    subdomains = forms.CharField(widget=forms.Textarea)
    
    # File Upload
    subdomains_file = forms.FileField(required=False)


    def save(self, id, subdomains_file):

        project = get_object_or_404(Project, id = id)
        subdomains = Subdomain.objects.filter(project = project)
        data = self.cleaned_data['subdomains']
        whole_subdomain = data.split('\r\n')
        whole_subdomain = set(whole_subdomain)


        subdomains_db = [str(subdomain) for subdomain in subdomains]

        new_subdomains = [str(newSubdomain) for newSubdomain in whole_subdomain if newSubdomain not in subdomains_db]

        if len(subdomains_file) != 0:

            for subdomain in subdomains_file:
                if subdomain not in new_subdomains and subdomain not in subdomains_db:
                    new_subdomains.append(subdomain)


        for subdomain in new_subdomains:
            Subdomain(project = project, subdomain = subdomain).save()

        #Resullerin kodu burada çalışacak
        subdomains = Subdomain.objects.filter(project= project)
        all_https = HttpServices.objects.filter(project = project)
        all_https = [str(http) for http in all_https]
        unique_https = []

        for i in all_https:
            if i not in unique_https:
                unique_https.append(i)
        print(unique_https)

        for item in range(len(subdomains)):

            # tek bir subdomain alıcaklar. 
            # subdomainin http servislerini bulup bana liste dönücekler
            # unique olması lazım

            for http_service in ["htttps//:www.google.com"]:
                if http_service not in unique_https:
                    HttpServices(subdomain = subdomains[item], project = project, http_service = http_service).save()
                    unique_https.append(http_service)
        

        pass


class HttpsServicesForm(forms.Form):
    http_services = forms.CharField(widget=forms.Textarea)


